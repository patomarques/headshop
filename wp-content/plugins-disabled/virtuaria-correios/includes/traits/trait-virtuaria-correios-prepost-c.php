<?php
 defined("\101\102\x53\120\101\x54\110") || die; trait Virtuaria_Correios_PrePost_Functions { private function get_formatted_prepost($order, $shipping) { $customer_phone = $order->get_meta("\x5f\x62\151\x6c\x6c\151\156\x67\x5f\x63\145\x6c\154\x70\150\157\x6e\145") ? $order->get_meta("\x5f\x62\151\x6c\x6c\x69\156\147\137\143\x65\154\154\x70\x68\157\156\x65") : $order->get_billing_phone(); if (!empty($customer_phone)) { $customer_phone = str_replace("\x2b\x35\x35", '', $customer_phone); $customer_phone = preg_replace("\57\134\104\57", '', $customer_phone); } $ddd = substr($customer_phone, 0, 2); $tel = substr($customer_phone, 2); $packages = array(); $items = array(); foreach ($order->get_items() as $item) { $product = $item->get_product(); if (!$product) { continue; } $packages["\143\x6f\x6e\x74\145\x6e\164\163"][] = array("\x64\141\x74\x61" => $product, "\161\165\x61\x6e\164\151\164\171" => $item->get_quantity()); $items[] = array("\x63\157\x6e\164\x65\165\144\x6f" => $product->get_title(), "\161\165\x61\156\164\151\x64\x61\144\x65" => strval($item->get_quantity()), "\x76\141\x6c\x6f\162" => $item->get_total() > 0 ? $item->get_total() : $product->get_price() * $item->get_quantity()); } $dimensions = $shipping->get_package_dimensions($packages); $additional_services = array(); if ("\x79\145\x73" === $shipping->get_option("\x72\145\143\x65\x69\x70\x74\x5f\156\x6f\x74\x69\143\145")) { $additional_services[] = array("\x63\x6f\144\x69\x67\x6f\123\x65\162\x76\x69\143\157\101\144\151\143\151\157\156\141\154" => "\x30\x30\61", "\x76\x61\154\x6f\x72\x44\145\x63\154\x61\162\x61\x64\x6f" => $order->get_total()); } if ("\x79\x65\163" === $shipping->get_option("\x6f\x77\x6e\137\x68\x61\156\x64\163")) { $additional_services[] = array("\143\x6f\144\151\x67\x6f\x53\x65\162\166\x69\x63\x6f\101\144\151\143\x69\157\x6e\x61\x6c" => "\x30\x30\x32", "\166\x61\154\x6f\162\x44\145\143\x6c\141\x72\x61\144\x6f" => $order->get_total()); } if ($shipping->get_option("\144\x65\143\154\141\162\145\137\166\x61\154\165\x65")) { $additional_services[] = array("\143\157\x64\151\x67\157\x53\x65\x72\x76\151\143\x6f\101\x64\x69\143\151\x6f\156\141\154" => $shipping->get_option("\x64\145\143\154\141\162\145\x5f\166\141\154\x75\x65"), "\166\x61\154\157\x72\x44\145\143\x6c\x61\162\141\x64\157" => $order->get_total()); } $prepost = array("\x72\145\155\145\x74\145\156\164\145" => array("\x6e\157\x6d\x65" => $shipping->get_setting("\146\165\x6c\x6c\137\156\141\x6d\x65"), "\145\155\141\x69\154" => $shipping->get_setting("\x65\155\141\151\x6c"), "\144\x64\x64\x43\145\154\x75\154\141\162" => $shipping->get_setting("\144\144\x64"), "\143\145\x6c\x75\x6c\x61\x72" => $shipping->get_setting("\146\x6f\156\145"), "\143\x70\x66\x43\x6e\160\x6a" => $shipping->get_setting("\x63\x70\146\143\156\x70\152"), "\145\156\x64\145\x72\145\x63\157" => array("\143\145\x70" => $shipping->get_setting("\157\x72\x69\x67\151\156"), "\154\157\x67\162\141\144\157\x75\162\157" => $shipping->get_setting("\x6c\x6f\x67\162\141\144\157\165\162\157"), "\x6e\x75\155\x65\x72\x6f" => $shipping->get_setting("\x6e\x75\x6d\145\x72\157"), "\142\141\151\162\162\157" => $shipping->get_setting("\142\x61\151\x72\x72\157"), "\x63\x69\x64\x61\x64\145" => $shipping->get_setting("\x63\151\x64\141\x64\145"), "\165\x66" => $shipping->get_setting("\145\163\164\141\x64\157"))), "\x64\145\163\164\x69\156\x61\164\141\162\151\x6f" => array("\156\157\x6d\x65" => trim($order->get_formatted_shipping_full_name()) ? $order->get_formatted_shipping_full_name() : $order->get_formatted_billing_full_name(), "\145\x6d\x61\x69\x6c" => $order->get_billing_email(), "\x64\144\x64\x43\145\x6c\x75\x6c\141\162" => $ddd, "\143\x65\154\165\x6c\x61\x72" => $tel, "\x63\x70\146\x43\x6e\x70\152" => preg_replace("\57\134\104\57", '', $this->get_cpf_cnpj($order)), "\x65\x6e\144\x65\162\145\x63\157" => array("\143\145\x70" => $order->get_shipping_postcode() ? preg_replace("\x2f\134\104\57", '', $order->get_shipping_postcode()) : preg_replace("\57\134\x44\x2f", '', $order->get_billing_postcode()), "\x6c\157\147\162\x61\x64\x6f\165\162\x6f" => $order->get_shipping_postcode() ? substr($order->get_shipping_address_1(), 0, 50) : substr($order->get_billing_address_1(), 0, 50), "\x6e\165\155\145\162\157" => $this->get_destination_number($order), "\142\x61\x69\162\x72\157" => substr($this->get_destination_neighborhood($order), 0, 29), "\x63\151\x64\x61\144\145" => $order->get_shipping_postcode() ? substr($order->get_shipping_city(), 0, 29) : substr($order->get_billing_city(), 0, 29), "\165\146" => $order->get_shipping_postcode() ? $order->get_shipping_state() : $order->get_billing_state())), "\x63\x6f\x64\x69\147\157\x53\x65\x72\x76\151\143\157" => $shipping->get_option("\163\x65\162\x76\151\x63\x65\x5f\143\157\144"), "\x63\x69\145\x6e\164\x65\x4f\142\152\145\x74\157\116\x61\157\120\x72\x6f\151\x62\151\144\x6f" => "\61", "\x6d\157\144\x61\x6c\x69\x64\141\144\x65\x50\141\x67\141\x6d\x65\x6e\164\x6f" => "\x32", "\154\157\x67\x69\163\164\x69\143\x61\x52\x65\166\145\162\x73\141" => "\116", "\160\x65\x73\157\x49\x6e\146\x6f\x72\x6d\141\x64\x6f" => isset($dimensions["\x77\145\x69\x67\150\x74"]) ? strval($dimensions["\x77\145\x69\147\150\x74"]) : "\60", "\x61\x6c\x74\x75\162\141\111\156\x66\157\x72\155\x61\x64\141" => isset($dimensions["\x68\145\151\x67\150\164"]) ? $dimensions["\150\145\151\147\150\x74"] : "\60", "\154\141\x72\x67\165\162\x61\111\156\146\x6f\162\x6d\x61\144\141" => isset($dimensions["\x77\151\x64\164\x68"]) ? $dimensions["\x77\x69\x64\x74\x68"] : "\x30", "\x63\157\x6d\x70\x72\151\x6d\145\156\164\157\x49\156\146\157\x72\155\141\x64\157" => isset($dimensions["\x6c\x65\x6e\147\164\150"]) ? $dimensions["\154\x65\x6e\147\164\150"] : "\x30", "\151\x74\x65\156\x73\104\145\143\x6c\141\162\141\x63\141\157\x43\157\x6e\x74\145\x75\144\x6f" => $items, "\154\151\163\164\141\123\x65\x72\166\x69\143\x6f\x41\144\151\143\151\x6f\156\141\154" => $additional_services, "\x75\163\x65\x72\x6e\x61\x6d\145" => $shipping->username, "\160\x61\x73\163\x77\x6f\162\x64" => $shipping->password, "\160\x6f\163\164\x5f\143\141\x72\x64" => $shipping->post_card, "\143\157\144\x69\x67\157\x46\x6f\162\155\x61\164\x6f\x4f\142\152\x65\164\157\111\x6e\x66\157\162\x6d\141\x64\157" => $shipping->get_option("\157\x62\152\145\143\164\137\164\x79\x70\x65", "\x32"), "\163\157\x6c\151\143\x69\x74\141\162\103\157\154\x65\x74\x61" => "\116", "\151\x64\103\157\x72\x72\x65\151\x6f\x73" => $shipping->username); $origin_complement = $shipping->get_setting("\x63\x6f\x6d\x70\154\145\155\x65\156\164\x6f"); if ($origin_complement) { $prepost["\162\145\155\x65\164\145\156\164\145"]["\x65\x6e\144\x65\x72\145\143\157"]["\x63\x6f\x6d\160\x6c\x65\155\x65\x6e\x74\x6f"] = substr($origin_complement, 0, 29); } $recipient_complement = $order->get_shipping_postcode() ? $order->get_shipping_address_2() : $order->get_billing_address_2(); if ($recipient_complement) { $prepost["\x64\x65\163\x74\151\156\x61\164\141\x72\x69\157"]["\x65\156\144\x65\162\x65\x63\x6f"]["\143\157\x6d\160\x6c\x65\x6d\145\156\x74\157"] = substr($recipient_complement, 0, 29); } if (isset($_POST["\x63\x72\145\x61\x74\145\x5f\x70\x72\145\x70\157\163\164\x5f\156\157\x6e\x63\x65"]) && wp_verify_nonce(sanitize_text_field(wp_unslash($_POST["\143\x72\145\141\x74\145\137\160\x72\x65\x70\x6f\163\x74\137\156\x6f\156\143\x65"])), "\143\162\145\x61\x74\x65\137\160\x72\145\x70\x6f\163\x74")) { if (isset($_POST["\156\146\x5f\x6b\145\x79"]) && !empty($_POST["\156\x66\x5f\153\x65\171"])) { $prepost["\x63\150\141\x76\x65\116\106\145"] = sanitize_text_field(wp_unslash($_POST["\x6e\x66\137\x6b\145\171"])); unset($prepost["\x69\164\x65\x6e\163\104\x65\143\x6c\141\162\141\x63\141\157\103\x6f\156\x74\x65\x75\144\x6f"]); } if (isset($_POST["\156\x66\137\156\165\155\142\145\162"]) && !empty($_POST["\156\x66\x5f\156\x75\x6d\142\145\162"])) { $prepost["\156\x75\x6d\145\x72\x6f\x4e\x6f\x74\x61\x46\x69\x73\143\x61\x6c"] = sanitize_text_field(wp_unslash($_POST["\156\146\x5f\156\165\x6d\142\x65\x72"])); unset($prepost["\x69\164\145\x6e\163\x44\x65\143\x6c\141\162\x61\143\x61\x6f\103\x6f\156\x74\145\165\x64\157"]); } } if ("\x32\x30\x31\x39\x32" === $prepost["\x63\x6f\x64\x69\x67\157\x53\x65\162\166\x69\x63\x6f"] || "\x31" === $shipping->get_option("\x6f\x62\x6a\x65\x63\164\137\x74\x79\160\x65", "\x32")) { unset($prepost["\143\x6f\155\x70\x72\x69\x6d\145\x6e\164\157\111\156\x66\x6f\x72\155\x61\x64\157"]); unset($prepost["\x61\154\164\x75\x72\141\111\x6e\x66\x6f\x72\155\141\144\141"]); unset($prepost["\154\141\162\x67\x75\162\x61\x49\x6e\146\x6f\162\155\141\144\x61"]); } $services_with_date_preview = apply_filters("\166\151\162\x74\x75\141\x72\x69\141\x5f\143\x6f\x72\x72\145\x69\x6f\163\x5f\x70\162\145\160\x6f\x73\x74\137\x73\145\162\x76\151\x63\145\x73\137\167\151\x74\150\x5f\x64\141\164\x65\x5f\160\162\145\166\x69\x65\x77", array(80160, 80250, 80390, 80152)); if (in_array($prepost["\x63\x6f\x64\151\x67\157\123\x65\x72\x76\151\143\157"], $services_with_date_preview)) { $prepost["\144\141\x74\141\120\162\145\166\x69\x73\x74\141\120\x6f\163\164\x61\x67\x65\155"] = wp_date("\144\x2f\x6d\x2f\131", strtotime("\53\x31\40\144\x61\x79")); } return $prepost; } private function get_cpf_cnpj($order) { $person_type = $order->get_meta("\142\151\x6c\154\x69\x6e\147\x5f\160\x65\x72\x73\157\156\137\164\x79\x70\x65"); if (!$person_type) { $person_type = $order->get_meta("\x5f\x62\x69\x6c\x6c\x69\156\147\137\x70\145\x72\x73\157\x6e\137\164\x79\x70\145"); } if ("\160\146" === $person_type) { $cpf = $order->get_meta("\x5f\x62\151\x6c\x6c\x69\x6e\x67\137\x63\160\146"); return $cpf ? $cpf : $order->get_meta("\142\x69\x6c\x6c\x69\156\x67\137\143\160\146"); } elseif ("\x70\152" === $person_type) { $cnpj = $order->get_meta("\137\x62\x69\154\154\151\x6e\147\137\143\156\x70\152"); return $cnpj ? $cnpj : $order->get_meta("\x62\x69\154\x6c\151\x6e\147\x5f\x63\x6e\x70\x6a"); } return false; } private function get_destination_number($order) { if ($order->get_shipping_postcode()) { $number = $order->get_meta("\x5f\x73\150\151\x70\x70\x69\x6e\x67\x5f\156\165\155\x62\145\x72"); return $number ? $number : $order->get_meta("\x73\150\151\x70\x70\x69\156\x67\x5f\x6e\165\155\x62\x65\x72"); } return $order->get_meta("\x5f\x62\x69\x6c\x6c\x69\x6e\147\137\156\165\155\142\x65\162") ? $order->get_meta("\137\142\x69\154\154\x69\156\147\137\156\x75\155\142\145\162") : $order->get_meta("\x62\x69\x6c\x6c\x69\156\x67\x5f\x6e\165\x6d\x62\x65\x72"); } private function get_destination_neighborhood($order) { if ($order->get_shipping_postcode()) { $neighborhood = $order->get_meta("\137\x73\150\151\160\x70\151\156\147\137\156\x65\x69\x67\150\142\x6f\x72\x68\x6f\x6f\144"); return $neighborhood ? $neighborhood : $order->get_meta("\163\x68\151\x70\160\151\x6e\x67\137\156\145\151\x67\150\142\157\x72\x68\157\157\144"); } $neighborhood = $order->get_meta("\137\x62\x69\154\154\x69\x6e\x67\137\156\x65\x69\147\x68\x62\x6f\x72\x68\x6f\x6f\x64"); return $neighborhood ? $neighborhood : $order->get_meta("\142\151\154\154\151\x6e\147\x5f\156\x65\x69\147\x68\x62\x6f\x72\150\157\x6f\x64"); } }